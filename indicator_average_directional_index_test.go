package techan

import (
	"math"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestADXIndicator(t *testing.T) {
	candles := [][]float64{
		{372.01, 372.94, 371.94, 372.94},
		{372.905, 373.86, 372.905, 373.49},
		{373.57, 374.0391, 373.54, 373.75},
		{373.76, 374.06, 373.5999, 373.891},
		{373.9, 374.13, 373.54, 373.75},
		{373.79, 374.34, 373.77, 374.34},
		{374.32, 374.399, 373.4601, 373.6},
		{373.63, 373.69, 373.01, 373.44},
		{373.47, 374.04, 373.25, 373.9617},
		{373.99, 374.66, 373.96, 374.43},
		{374.43, 374.48, 373.57, 374.06},
		{374.065, 374.57, 374.0043, 374.56},
		{374.58, 374.585, 374.23, 374.47},
		{374.48, 374.85, 374.4, 374.5701},
		{374.59, 374.64, 374.31, 374.46},
		{374.44, 374.77, 374.37, 374.68},
		{374.685, 374.72, 373.8, 374.23},
		{374.25, 374.2799, 373.73, 373.96},
		{373.94, 374.06, 373.32, 373.57},
		{373.58, 373.73, 373.2201, 373.48},
		{373.45, 373.86, 373.28, 373.82},
		{373.82, 373.83, 373.03, 373.42},
		{373.44, 373.58, 372.61, 372.61},
		{372.56, 373.16, 372.37, 373.0494},
		{373.06, 373.18, 372.9328, 372.9459},
		{372.91, 373.319, 372.67, 373.29},
		{373.3, 373.63, 373.24, 373.625},
		{373.64, 373.72, 373.375, 373.621},
		{373.59, 373.94, 373.5809, 373.9101},
		{373.885, 374.13, 373.83, 374.0124},
		{374.01, 374.1, 373.89, 374.0686},
	}
	series := mockTimeSeriesOCHL(candles...)

	expected := []int{
		0,
		1,
		9,
		16,
		18,
		19,
		18,
		18,
		19,
		17,
		18,
		18,
		17,
		15,
		15,
		16,
		18,
		21,
	}

	adxIndicator := NewADXAndDIIndicator(series, 14, 0)

	for i := 13; i < len(candles); i++ {
		adx, _, _ := adxIndicator.Calculate(i)
		assert.EqualValues(t, math.Round(adx.Float()), expected[i-13])
	}
}
